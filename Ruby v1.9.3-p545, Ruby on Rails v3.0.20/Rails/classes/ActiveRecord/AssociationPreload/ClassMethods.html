<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>ActiveRecord::AssociationPreload::ClassMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/github.css" type="text/css" media="screen" />
<script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
            <span>Ruby on Rails 3.0.20</span><br />
        
        <h1>
            <span class="type">Module</span> 
            ActiveRecord::AssociationPreload::ClassMethods 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/activerecord/lib/active_record/association_preload_rb.html">activerecord/lib/active_record/association_preload.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  
    <div class="description">
      
<p>Implements the details of eager loading of Active Record associations.
Application developers should not use this module directly.</p>

<p><code>ActiveRecord::Base</code> is extended with this module. The source
code in <code>ActiveRecord::Base</code> references methods defined in this
module.</p>

<p>Note that &#39;eager loading&#39; and &#39;preloading&#39; are actually the
same thing. However, there are two different eager loading strategies.</p>

<p>The first one is by using table joins. This was only strategy available
prior to Rails 2.1. Suppose that you have an Author model with columns
&#39;name&#39; and &#39;age&#39;, and a Book model with columns
&#39;name&#39; and &#39;sales&#39;. Using this strategy, Active Record
would try to retrieve all data for an author and all of its books via a
single query:</p>

<pre><code>SELECT * FROM authors
LEFT OUTER JOIN books ON authors.id = books.id
WHERE authors.name = &#39;Ken Akamatsu&#39;</code></pre>

<p>However, this could result in many rows that contain redundant data. After
having received the first row, we already have enough data to instantiate
the Author object. In all subsequent rows, only the data for the joined
&#39;books&#39; table is useful; the joined &#39;authors&#39; data is just
redundant, and processing this redundant data takes memory and CPU time.
The problem quickly becomes worse and worse as the level of eager loading
increases (i.e. if Active Record is to eager load the associations&#39;
associations as well).</p>

<p>The second strategy is to use multiple database queries, one for each level
of association. Since Rails 2.1, this is the default strategy. In
situations where a table join is necessary (e.g. when the
<code>:conditions</code> option references an association&#39;s column), it
will fallback to the table join strategy.</p>

<p>See also <a
href="../Associations/ClassMethods.html">ActiveRecord::Associations::ClassMethods</a>,
which explains eager loading in a more high-level (application
developer-friendly) manner.</p>

    </div>
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-add_preloaded_record_to_collection">add_preloaded_record_to_collection</a>,
              </li>
            
              
              <li>
                <a href="#method-i-add_preloaded_records_to_collection">add_preloaded_records_to_collection</a>,
              </li>
            
              
              <li>
                <a href="#method-i-append_conditions">append_conditions</a>,
              </li>
            
              
              <li>
                <a href="#method-i-associated_records">associated_records</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>C</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-construct_id_map">construct_id_map</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>F</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-find_associated_records">find_associated_records</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>I</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-in_or_equals_for_ids">in_or_equals_for_ids</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>P</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-preload_associations">preload_associations</a>,
              </li>
            
              
              <li>
                <a href="#method-i-preload_belongs_to_association">preload_belongs_to_association</a>,
              </li>
            
              
              <li>
                <a href="#method-i-preload_has_and_belongs_to_many_association">preload_has_and_belongs_to_many_association</a>,
              </li>
            
              
              <li>
                <a href="#method-i-preload_has_many_association">preload_has_many_association</a>,
              </li>
            
              
              <li>
                <a href="#method-i-preload_has_one_association">preload_has_one_association</a>,
              </li>
            
              
              <li>
                <a href="#method-i-preload_one_association">preload_one_association</a>,
              </li>
            
              
              <li>
                <a href="#method-i-preload_through_records">preload_through_records</a>,
              </li>
            
              
              <li>
                <a href="#method-i-process_conditions_for_preload">process_conditions_for_preload</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>S</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-set_association_collection_records">set_association_collection_records</a>,
              </li>
            
              
              <li>
                <a href="#method-i-set_association_single_records">set_association_single_records</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
        
      <div class="sectiontitle">Instance Protected methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-preload_associations">
            
              <b>preload_associations</b>(records, associations, preload_options={})
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-preload_associations" name="method-i-preload_associations" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Eager loads the named associations for the given Active Record record(s).</p>

<p>In this description, &#39;association name&#39; shall refer to the name
passed to an association creation method. For example, a model that
specifies <code>belongs_to :author</code>, <code>has_many :buyers</code>
has association names <code>:author</code> and <code>:buyers</code>.</p>

<h2 id="method-i-preload_associations-label-Parameters">Parameters</h2>

<p><code>records</code> is an array of <a
href="../Base.html">ActiveRecord::Base</a>. This array needs not be flat,
i.e. <code>records</code> itself may also contain arrays of records. In any
case, <code>preload_associations</code> will preload the all associations
records by flattening <code>records</code>.</p>

<p><code>associations</code> specifies one or more associations that you want
to preload. It may be:</p>
<ul><li>
<p>a Symbol or a String which specifies a single association name. For
example, specifying <code>:books</code> allows this method to preload all
books for an Author.</p>
</li><li>
<p>an <a href="../../Array.html">Array</a> which specifies multiple
association names. This array is processed recursively. For example,
specifying <code>[:avatar, :books]</code> allows this method to preload an
author&#39;s avatar as well as all of his books.</p>
</li><li>
<p>a Hash which specifies multiple association names, as well as association
names for the to-be-preloaded association objects. For example, specifying
<code>{ :author =&gt; :avatar }</code> will preload a book&#39;s author, as
well as that author&#39;s avatar.</p>
</li></ul>

<p><code>:associations</code> has the same format as the <code>:include</code>
option for <code>ActiveRecord::Base.find</code>. So
<code>associations</code> could look like this:</p>

<pre><code>:books
[ :books, :author ]
{ :author =&gt; :avatar }
[ :books, { :author =&gt; :avatar } ]
</code></pre>

<p><code>preload_options</code> contains options that will be passed to
ActiveRecord::Base#find (which is called under the hood for preloading
records). But it is passed only one level deep in the
<code>associations</code> argument, i.e. it&#39;s not passed to the child
associations when <code>associations</code> is a Hash.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-preload_associations_source')" id="l_method-i-preload_associations_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L87" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-preload_associations_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 87</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">associations</span>, <span class="ruby-identifier">preload_options</span>={})
  <span class="ruby-identifier">records</span> = <span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">records</span>).<span class="ruby-identifier">compact</span>
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">empty?</span>
  <span class="ruby-keyword">case</span> <span class="ruby-identifier">associations</span>
  <span class="ruby-keyword">when</span> <span class="ruby-constant">Array</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">associations</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">association</span><span class="ruby-operator">|</span> <span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">association</span>, <span class="ruby-identifier">preload_options</span>)}
  <span class="ruby-keyword">when</span> <span class="ruby-constant">Symbol</span>, <span class="ruby-constant">String</span> <span class="ruby-keyword">then</span> <span class="ruby-identifier">preload_one_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">associations</span>.<span class="ruby-identifier">to_sym</span>, <span class="ruby-identifier">preload_options</span>)
  <span class="ruby-keyword">when</span> <span class="ruby-constant">Hash</span> <span class="ruby-keyword">then</span>
    <span class="ruby-identifier">associations</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent</span>, <span class="ruby-identifier">child</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">raise</span> <span class="ruby-string">&quot;parent must be an association name&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">String</span>) <span class="ruby-operator">||</span> <span class="ruby-identifier">parent</span>.<span class="ruby-identifier">is_a?</span>(<span class="ruby-constant">Symbol</span>)
      <span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">parent</span>, <span class="ruby-identifier">preload_options</span>)
      <span class="ruby-identifier">reflection</span> = <span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">parent</span>]
      <span class="ruby-identifier">parents</span> = <span class="ruby-identifier">records</span>.<span class="ruby-identifier">sum</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>)) }
      <span class="ruby-keyword">unless</span> <span class="ruby-identifier">parents</span>.<span class="ruby-identifier">empty?</span>
        <span class="ruby-identifier">parents</span> = <span class="ruby-identifier">parents</span>.<span class="ruby-identifier">uniq</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">macro</span> <span class="ruby-operator">==</span> <span class="ruby-value">:belongs_to</span>
        <span class="ruby-identifier">parents</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">parents</span>, <span class="ruby-identifier">child</span>)
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
              
      <div class="sectiontitle">Instance Private methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-add_preloaded_record_to_collection">
            
              <b>add_preloaded_record_to_collection</b>(parent_records, reflection_name, associated_record)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-add_preloaded_record_to_collection" name="method-i-add_preloaded_record_to_collection" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-add_preloaded_record_to_collection_source')" id="l_method-i-add_preloaded_record_to_collection_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L136" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-add_preloaded_record_to_collection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 136</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">add_preloaded_record_to_collection</span>(<span class="ruby-identifier">parent_records</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_record</span>)
  <span class="ruby-identifier">parent_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent_record</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">parent_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;set_#{reflection_name}_target&quot;</span>, <span class="ruby-identifier">associated_record</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-add_preloaded_records_to_collection">
            
              <b>add_preloaded_records_to_collection</b>(parent_records, reflection_name, associated_record)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-add_preloaded_records_to_collection" name="method-i-add_preloaded_records_to_collection" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-add_preloaded_records_to_collection_source')" id="l_method-i-add_preloaded_records_to_collection_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L126" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-add_preloaded_records_to_collection_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 126</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">add_preloaded_records_to_collection</span>(<span class="ruby-identifier">parent_records</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_record</span>)
  <span class="ruby-identifier">parent_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">parent_record</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">association_proxy</span> = <span class="ruby-identifier">parent_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection_name</span>)
    <span class="ruby-identifier">association_proxy</span>.<span class="ruby-identifier">loaded</span>
    <span class="ruby-identifier">association_proxy</span>.<span class="ruby-identifier">target</span>.<span class="ruby-identifier">push</span>(<span class="ruby-operator">*</span><span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">associated_record</span>))

    <span class="ruby-identifier">association_proxy</span>.<span class="ruby-identifier">__send__</span>(<span class="ruby-value">:set_inverse_instance</span>, <span class="ruby-identifier">associated_record</span>, <span class="ruby-identifier">parent_record</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-append_conditions">
            
              <b>append_conditions</b>(reflection, preload_options)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-append_conditions" name="method-i-append_conditions" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-append_conditions_source')" id="l_method-i-append_conditions_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L408" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-append_conditions_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 408</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">append_conditions</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)
  <span class="ruby-identifier">sql</span> = <span class="ruby-string">&quot;&quot;</span>
  <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; AND (#{process_conditions_for_preload(reflection.options[:conditions], reflection.klass)})&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>]
  <span class="ruby-identifier">sql</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-node">&quot; AND (#{process_conditions_for_preload(preload_options[:conditions])})&quot;</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:conditions</span>]
  <span class="ruby-identifier">sql</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-associated_records">
            
              <b>associated_records</b>(ids)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-associated_records" name="method-i-associated_records" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Some databases impose a limit on the number of ids in a list (in Oracle its
1000) Make several smaller queries if necessary or make one query if the
adapter supports it</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-associated_records_source')" id="l_method-i-associated_records_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L421" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-associated_records_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 421</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">associated_records</span>(<span class="ruby-identifier">ids</span>)
  <span class="ruby-identifier">max_ids_in_a_list</span> = <span class="ruby-identifier">connection</span>.<span class="ruby-identifier">ids_in_list_limit</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">size</span>
  <span class="ruby-identifier">records</span> = []
  <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">each_slice</span>(<span class="ruby-identifier">max_ids_in_a_list</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">some_ids</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">records</span> <span class="ruby-operator">+=</span> <span class="ruby-keyword">yield</span>(<span class="ruby-identifier">some_ids</span>)
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">records</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-construct_id_map">
            
              <b>construct_id_map</b>(records, primary_key=nil)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-construct_id_map" name="method-i-construct_id_map" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Given a collection of Active Record objects, constructs a Hash which maps
the objects&#39; IDs to the relevant objects. Returns a 2-tuple
<code>(id_to_record_map, ids)</code> where <code>id_to_record_map</code> is
the Hash, and <code>ids</code> is an <a href="../../Array.html">Array</a>
of record IDs.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-construct_id_map_source')" id="l_method-i-construct_id_map_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L175" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-construct_id_map_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 175</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">construct_id_map</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">primary_key</span>=<span class="ruby-keyword">nil</span>)
  <span class="ruby-identifier">id_to_record_map</span> = {}
  <span class="ruby-identifier">ids</span> = []
  <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">primary_key</span> <span class="ruby-operator">||=</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">primary_key</span>
    <span class="ruby-identifier">ids</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>[<span class="ruby-identifier">primary_key</span>]
    <span class="ruby-identifier">mapped_records</span> = (<span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">ids</span>.<span class="ruby-identifier">last</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span> [])
    <span class="ruby-identifier">mapped_records</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">uniq!</span>
  <span class="ruby-keyword">return</span> <span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">ids</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-find_associated_records">
            
              <b>find_associated_records</b>(ids, reflection, preload_options)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-find_associated_records" name="method-i-find_associated_records" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-find_associated_records_source')" id="l_method-i-find_associated_records_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L365" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-find_associated_records_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 365</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">find_associated_records</span>(<span class="ruby-identifier">ids</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)
  <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>
  <span class="ruby-identifier">table_name</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">quoted_table_name</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">interface</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:as</span>]
    <span class="ruby-identifier">conditions</span> = <span class="ruby-node">&quot;#{reflection.klass.quoted_table_name}.#{connection.quote_column_name &quot;#{interface}_id&quot;} #{in_or_equals_for_ids(ids)} and #{reflection.klass.quoted_table_name}.#{connection.quote_column_name &quot;#{interface}_type&quot;} = &#39;#{self.base_class.sti_name}&#39;&quot;</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">foreign_key</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">primary_key_name</span>
    <span class="ruby-identifier">conditions</span> = <span class="ruby-node">&quot;#{reflection.klass.quoted_table_name}.#{foreign_key} #{in_or_equals_for_ids(ids)}&quot;</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">append_conditions</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)

  <span class="ruby-identifier">find_options</span> = {
    <span class="ruby-value">:select</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:select</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:select</span>] <span class="ruby-operator">||</span> <span class="ruby-constant">Arel</span><span class="ruby-operator">::</span><span class="ruby-constant">SqlLiteral</span>.<span class="ruby-identifier">new</span>(<span class="ruby-node">&quot;#{table_name}.*&quot;</span>),
    <span class="ruby-value">:include</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:include</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>],
    <span class="ruby-value">:joins</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:joins</span>],
    <span class="ruby-value">:group</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:group</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:group</span>],
    <span class="ruby-value">:order</span> =<span class="ruby-operator">&gt;</span> <span class="ruby-identifier">preload_options</span>[<span class="ruby-value">:order</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>]
  }

  <span class="ruby-identifier">associated_records</span>(<span class="ruby-identifier">ids</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">some_ids</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">scoped</span>.<span class="ruby-identifier">apply_finder_options</span>(<span class="ruby-identifier">find_options</span>.<span class="ruby-identifier">merge</span>(<span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">some_ids</span>])).<span class="ruby-identifier">to_a</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-in_or_equals_for_ids">
            
              <b>in_or_equals_for_ids</b>(ids)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-in_or_equals_for_ids" name="method-i-in_or_equals_for_ids" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-in_or_equals_for_ids_source')" id="l_method-i-in_or_equals_for_ids_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L415" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-in_or_equals_for_ids_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 415</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">in_or_equals_for_ids</span>(<span class="ruby-identifier">ids</span>)
  <span class="ruby-identifier">ids</span>.<span class="ruby-identifier">size</span> <span class="ruby-operator">&gt;</span> <span class="ruby-number">1</span> <span class="ruby-operator">?</span> <span class="ruby-string">&quot;IN (?)&quot;</span> <span class="ruby-operator">:</span> <span class="ruby-string">&quot;= ?&quot;</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-preload_belongs_to_association">
            
              <b>preload_belongs_to_association</b>(records, reflection, preload_options={})
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-preload_belongs_to_association" name="method-i-preload_belongs_to_association" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-preload_belongs_to_association_source')" id="l_method-i-preload_belongs_to_association_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L304" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-preload_belongs_to_association_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 304</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">preload_belongs_to_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>={})
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;loaded_#{reflection.name}?&quot;</span>)
  <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>
  <span class="ruby-identifier">primary_key_name</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">primary_key_name</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:polymorphic</span>]
    <span class="ruby-identifier">polymorph_type</span> = <span class="ruby-identifier">options</span>[<span class="ruby-value">:foreign_type</span>]
    <span class="ruby-identifier">klasses_and_ids</span> = {}

    <span class="ruby-comment"># Construct a mapping from klass to a list of ids to load and a mapping of those ids back</span>
    <span class="ruby-comment"># to their parent_records</span>
    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">polymorph_type</span>)
        <span class="ruby-identifier">klass_id</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">primary_key_name</span>)
        <span class="ruby-keyword">if</span> <span class="ruby-identifier">klass_id</span>
          <span class="ruby-identifier">id_map</span> = <span class="ruby-identifier">klasses_and_ids</span>[<span class="ruby-identifier">klass</span>] <span class="ruby-operator">||=</span> {}
          <span class="ruby-identifier">id_list_for_klass_id</span> = (<span class="ruby-identifier">id_map</span>[<span class="ruby-identifier">klass_id</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span> [])
          <span class="ruby-identifier">id_list_for_klass_id</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">klasses_and_ids</span> = <span class="ruby-identifier">klasses_and_ids</span>.<span class="ruby-identifier">to_a</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">id_map</span> = {}
    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">key</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">primary_key_name</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">key</span>
        <span class="ruby-identifier">mapped_records</span> = (<span class="ruby-identifier">id_map</span>[<span class="ruby-identifier">key</span>.<span class="ruby-identifier">to_s</span>] <span class="ruby-operator">||=</span> [])
        <span class="ruby-identifier">mapped_records</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">record</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
    <span class="ruby-identifier">klasses_and_ids</span> = [[<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">id_map</span>]]
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">klasses_and_ids</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">klass_and_id</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">klass_name</span>, <span class="ruby-identifier">id_map</span> = <span class="ruby-operator">*</span><span class="ruby-identifier">klass_and_id</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">id_map</span>.<span class="ruby-identifier">empty?</span>
    <span class="ruby-identifier">klass</span> = <span class="ruby-identifier">klass_name</span>.<span class="ruby-identifier">constantize</span>

    <span class="ruby-identifier">table_name</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">quoted_table_name</span>
    <span class="ruby-identifier">primary_key</span> = (<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:primary_key</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">primary_key</span>).<span class="ruby-identifier">to_s</span>
    <span class="ruby-identifier">column_type</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">columns</span>.<span class="ruby-identifier">detect</span>{<span class="ruby-operator">|</span><span class="ruby-identifier">c</span><span class="ruby-operator">|</span> <span class="ruby-identifier">c</span>.<span class="ruby-identifier">name</span> <span class="ruby-operator">==</span> <span class="ruby-identifier">primary_key</span>}.<span class="ruby-identifier">type</span>
    <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">id_map</span>.<span class="ruby-identifier">keys</span>.<span class="ruby-identifier">map</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span><span class="ruby-operator">|</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">column_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:integer</span>
        <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_i</span>
      <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">column_type</span> <span class="ruby-operator">==</span> <span class="ruby-value">:float</span>
        <span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_f</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">id</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">conditions</span> = <span class="ruby-node">&quot;#{table_name}.#{connection.quote_column_name(primary_key)} #{in_or_equals_for_ids(ids)}&quot;</span>
    <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">append_conditions</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)

    <span class="ruby-identifier">associated_records</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">unscoped</span>.<span class="ruby-identifier">where</span>([<span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">ids</span>]).<span class="ruby-identifier">apply_finder_options</span>(<span class="ruby-identifier">options</span>.<span class="ruby-identifier">slice</span>(<span class="ruby-value">:include</span>, <span class="ruby-value">:select</span>, <span class="ruby-value">:joins</span>, <span class="ruby-value">:order</span>)).<span class="ruby-identifier">to_a</span>

    <span class="ruby-identifier">set_association_single_records</span>(<span class="ruby-identifier">id_map</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">associated_records</span>, <span class="ruby-identifier">primary_key</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-preload_has_and_belongs_to_many_association">
            
              <b>preload_has_and_belongs_to_many_association</b>(records, reflection, preload_options={})
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-preload_has_and_belongs_to_many_association" name="method-i-preload_has_and_belongs_to_many_association" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-preload_has_and_belongs_to_many_association_source')" id="l_method-i-preload_has_and_belongs_to_many_association_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L188" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-preload_has_and_belongs_to_many_association_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 188</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">preload_has_and_belongs_to_many_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>={})
  <span class="ruby-identifier">table_name</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">quoted_table_name</span>
  <span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">construct_id_map</span>(<span class="ruby-identifier">records</span>)
  <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">loaded</span>}
  <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>

  <span class="ruby-identifier">conditions</span> = <span class="ruby-node">&quot;t0.#{reflection.primary_key_name} #{in_or_equals_for_ids(ids)}&quot;</span>
  <span class="ruby-identifier">conditions</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">append_conditions</span>(<span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)

  <span class="ruby-identifier">associated_records_proxy</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">unscoped</span>.
      <span class="ruby-identifier">includes</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>]).
      <span class="ruby-identifier">joins</span>(<span class="ruby-node">&quot;INNER JOIN #{connection.quote_table_name options[:join_table]} t0 ON #{reflection.klass.quoted_table_name}.#{reflection.klass.primary_key} = t0.#{reflection.association_foreign_key}&quot;</span>).
      <span class="ruby-identifier">select</span>(<span class="ruby-node">&quot;#{options[:select] || table_name+&#39;.*&#39;}, t0.#{reflection.primary_key_name} as the_parent_record_id&quot;</span>).
      <span class="ruby-identifier">order</span>(<span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>])

  <span class="ruby-identifier">all_associated_records</span> = <span class="ruby-identifier">associated_records</span>(<span class="ruby-identifier">ids</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">some_ids</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">associated_records_proxy</span>.<span class="ruby-identifier">where</span>([<span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">ids</span>]).<span class="ruby-identifier">to_a</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">set_association_collection_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">all_associated_records</span>, <span class="ruby-string">&#39;the_parent_record_id&#39;</span>)
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-preload_has_many_association">
            
              <b>preload_has_many_association</b>(records, reflection, preload_options={})
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-preload_has_many_association" name="method-i-preload_has_many_association" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-preload_has_many_association_source')" id="l_method-i-preload_has_many_association_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L241" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-preload_has_many_association_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 241</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">preload_has_many_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>={})
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">loaded?</span>
  <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>

  <span class="ruby-identifier">primary_key_name</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">through_reflection_primary_key_name</span>
  <span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">construct_id_map</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">primary_key_name</span> <span class="ruby-operator">||</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:primary_key</span>])
  <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>).<span class="ruby-identifier">loaded</span>}

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>]
    <span class="ruby-identifier">through_records</span> = <span class="ruby-identifier">preload_through_records</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>])
    <span class="ruby-identifier">through_reflection</span> = <span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>]]
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">source</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">source_reflection</span>.<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">through_records</span>, <span class="ruby-identifier">source</span>, <span class="ruby-identifier">options</span>)
      <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">through_record</span><span class="ruby-operator">|</span>
        <span class="ruby-identifier">through_record_id</span> = <span class="ruby-identifier">through_record</span>[<span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">through_reflection_primary_key</span>].<span class="ruby-identifier">to_s</span>
        <span class="ruby-identifier">add_preloaded_records_to_collection</span>(<span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">through_record_id</span>], <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">through_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">source</span>))
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">set_association_collection_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">find_associated_records</span>(<span class="ruby-identifier">ids</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>),
                                       <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">primary_key_name</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-preload_has_one_association">
            
              <b>preload_has_one_association</b>(records, reflection, preload_options={})
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-preload_has_one_association" name="method-i-preload_has_one_association" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-preload_has_one_association_source')" id="l_method-i-preload_has_one_association_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L210" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-preload_has_one_association_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 210</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">preload_has_one_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>={})
  <span class="ruby-keyword">return</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;loaded_#{reflection.name}?&quot;</span>)
  <span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">ids</span> = <span class="ruby-identifier">construct_id_map</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:primary_key</span>])
  <span class="ruby-identifier">options</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>
  <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;set_#{reflection.name}_target&quot;</span>, <span class="ruby-keyword">nil</span>)}
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>]
    <span class="ruby-identifier">through_records</span> = <span class="ruby-identifier">preload_through_records</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>])
    <span class="ruby-identifier">through_reflection</span> = <span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">options</span>[<span class="ruby-value">:through</span>]]
    <span class="ruby-identifier">through_primary_key</span> = <span class="ruby-identifier">through_reflection</span>.<span class="ruby-identifier">primary_key_name</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">empty?</span>
      <span class="ruby-identifier">source</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">source_reflection</span>.<span class="ruby-identifier">name</span>
      <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">through_records</span>, <span class="ruby-identifier">source</span>)
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">through_reflection</span>.<span class="ruby-identifier">macro</span> <span class="ruby-operator">==</span> <span class="ruby-value">:belongs_to</span>
        <span class="ruby-identifier">rev_id_to_record_map</span>, <span class="ruby-identifier">rev_ids</span> = <span class="ruby-identifier">construct_id_map</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">through_primary_key</span>)
        <span class="ruby-identifier">rev_primary_key</span> = <span class="ruby-identifier">through_reflection</span>.<span class="ruby-identifier">klass</span>.<span class="ruby-identifier">primary_key</span>
        <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">through_record</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">add_preloaded_record_to_collection</span>(<span class="ruby-identifier">rev_id_to_record_map</span>[<span class="ruby-identifier">through_record</span>[<span class="ruby-identifier">rev_primary_key</span>].<span class="ruby-identifier">to_s</span>],
                                             <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">through_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">source</span>))
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">through_record</span><span class="ruby-operator">|</span>
          <span class="ruby-identifier">add_preloaded_record_to_collection</span>(<span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">through_record</span>[<span class="ruby-identifier">through_primary_key</span>].<span class="ruby-identifier">to_s</span>],
                                             <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">through_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">source</span>))
        <span class="ruby-keyword">end</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">set_association_single_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>, <span class="ruby-identifier">find_associated_records</span>(<span class="ruby-identifier">ids</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>), <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">primary_key_name</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-preload_one_association">
            
              <b>preload_one_association</b>(records, association, preload_options={})
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-preload_one_association" name="method-i-preload_one_association" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Preloads a specific named association for the given records. This is called
by <code>preload_associations</code> as its base case.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-preload_one_association_source')" id="l_method-i-preload_one_association_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L111" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-preload_one_association_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 111</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">preload_one_association</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">association</span>, <span class="ruby-identifier">preload_options</span>={})
  <span class="ruby-identifier">class_to_reflection</span> = {}
  <span class="ruby-comment"># Not all records have the same class, so group then preload</span>
  <span class="ruby-comment"># group on the reflection itself so that if various subclass share the same association then</span>
  <span class="ruby-comment"># we do not split them unnecessarily</span>
  <span class="ruby-identifier">records</span>.<span class="ruby-identifier">group_by</span> { <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">class_to_reflection</span>[<span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>] <span class="ruby-operator">||=</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">association</span>]}.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">_records</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">raise</span> <span class="ruby-constant">ConfigurationError</span>, <span class="ruby-node">&quot;Association named &#39;#{ association }&#39; was not found; perhaps you misspelled it?&quot;</span> <span class="ruby-keyword">unless</span> <span class="ruby-identifier">reflection</span>

    <span class="ruby-comment"># &#39;reflection.macro&#39; can return &#39;belongs_to&#39;, &#39;has_many&#39;, etc. Thus,</span>
    <span class="ruby-comment"># the following could call &#39;preload_belongs_to_association&#39;,</span>
    <span class="ruby-comment"># &#39;preload_has_many_association&#39;, etc.</span>
    <span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;preload_#{reflection.macro}_association&quot;</span>, <span class="ruby-identifier">_records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">preload_options</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-preload_through_records">
            
              <b>preload_through_records</b>(records, reflection, through_association)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-preload_through_records" name="method-i-preload_through_records" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-preload_through_records_source')" id="l_method-i-preload_through_records_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L267" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-preload_through_records_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 267</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">preload_through_records</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-identifier">through_association</span>)
  <span class="ruby-identifier">through_reflection</span> = <span class="ruby-identifier">reflections</span>[<span class="ruby-identifier">through_association</span>]
  <span class="ruby-identifier">through_primary_key</span> = <span class="ruby-identifier">through_reflection</span>.<span class="ruby-identifier">primary_key_name</span>

  <span class="ruby-identifier">through_records</span> = []
  <span class="ruby-keyword">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:source_type</span>]
    <span class="ruby-identifier">interface</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">source_reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:foreign_type</span>]
    <span class="ruby-identifier">preload_options</span> = {<span class="ruby-value">:conditions</span> =<span class="ruby-operator">&gt;</span> [<span class="ruby-node">&quot;#{connection.quote_column_name interface} = ?&quot;</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:source_type</span>]]}

    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">compact!</span>
    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">through_association</span>, <span class="ruby-identifier">preload_options</span>)

    <span class="ruby-comment"># Dont cache the association - we would only be caching a subset</span>
    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">proxy</span> = <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">through_association</span>)

      <span class="ruby-keyword">if</span> <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:target</span>)
        <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">concat</span> <span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">target</span>)
        <span class="ruby-identifier">proxy</span>.<span class="ruby-identifier">reset</span>
      <span class="ruby-keyword">else</span> <span class="ruby-comment"># this is a has_one :through reflection</span>
        <span class="ruby-identifier">through_records</span> <span class="ruby-operator">&lt;&lt;</span> <span class="ruby-identifier">proxy</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">proxy</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">options</span> = {}
    <span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>] = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:include</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:source</span>] <span class="ruby-keyword">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>] <span class="ruby-operator">||</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>]
    <span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>] = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:order</span>]
    <span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>] = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">options</span>[<span class="ruby-value">:conditions</span>]
    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">first</span>.<span class="ruby-identifier">class</span>.<span class="ruby-identifier">preload_associations</span>(<span class="ruby-identifier">records</span>, <span class="ruby-identifier">through_association</span>, <span class="ruby-identifier">options</span>)

    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">through_records</span>.<span class="ruby-identifier">concat</span> <span class="ruby-constant">Array</span>.<span class="ruby-identifier">wrap</span>(<span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-identifier">through_association</span>))
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>
  <span class="ruby-identifier">through_records</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-process_conditions_for_preload">
            
              <b>process_conditions_for_preload</b>(conditions, klass = self)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-process_conditions_for_preload" name="method-i-process_conditions_for_preload" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-process_conditions_for_preload_source')" id="l_method-i-process_conditions_for_preload_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L391" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-process_conditions_for_preload_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 391</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">process_conditions_for_preload</span>(<span class="ruby-identifier">conditions</span>, <span class="ruby-identifier">klass</span> = <span class="ruby-keyword">self</span>)
  <span class="ruby-identifier">sanitized</span> = <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:sanitize_sql</span>, <span class="ruby-identifier">conditions</span>)

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">sanitized</span> <span class="ruby-operator">=~</span> <span class="ruby-node">/\#\{.*\}/</span>
    <span class="ruby-constant">ActiveSupport</span><span class="ruby-operator">::</span><span class="ruby-constant">Deprecation</span>.<span class="ruby-identifier">warn</span>(
      <span class="ruby-string">&#39;String-based interpolation of association conditions is deprecated. Please use a &#39;</span>              <span class="ruby-string">&#39;proc instead. So, for example, has_many :older_friends, :conditions =&gt; \age &gt; #{age}\ &#39;</span>              <span class="ruby-string">&#39;should be changed to has_many :older_friends, :conditions =&gt; proc { &quot;age &gt; #{age}&quot; }.&#39;</span>
    )
    <span class="ruby-identifier">instance_eval</span>(<span class="ruby-node">&quot;%@#{sanitized.gsub(&#39;@&#39;, &#39;\@&#39;)}@&quot;</span>, <span class="ruby-keyword">__FILE__</span>, <span class="ruby-keyword">__LINE__</span>)
  <span class="ruby-keyword">elsif</span> <span class="ruby-identifier">conditions</span>.<span class="ruby-identifier">respond_to?</span>(<span class="ruby-value">:to_proc</span>)
    <span class="ruby-identifier">klass</span>.<span class="ruby-identifier">send</span>(<span class="ruby-value">:sanitize_sql</span>, <span class="ruby-identifier">instance_eval</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">conditions</span>))
  <span class="ruby-keyword">else</span>
    <span class="ruby-identifier">sanitized</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-set_association_collection_records">
            
              <b>set_association_collection_records</b>(id_to_record_map, reflection_name, associated_records, key)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-set_association_collection_records" name="method-i-set_association_collection_records" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-set_association_collection_records_source')" id="l_method-i-set_association_collection_records_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L142" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-set_association_collection_records_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 142</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">set_association_collection_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_records</span>, <span class="ruby-identifier">key</span>)
  <span class="ruby-identifier">associated_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">associated_record</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">mapped_records</span> = <span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">associated_record</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_s</span>]
    <span class="ruby-identifier">add_preloaded_records_to_collection</span>(<span class="ruby-identifier">mapped_records</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_record</span>)
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-set_association_single_records">
            
              <b>set_association_single_records</b>(id_to_record_map, reflection_name, associated_records, key)
            
            <a href="../../../classes/ActiveRecord/AssociationPreload/ClassMethods.html#method-i-set_association_single_records" name="method-i-set_association_single_records" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-set_association_single_records_source')" id="l_method-i-set_association_single_records_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/3836dc6b4ed5a2bda980871c31270e2195713a66/activerecord/lib/active_record/association_preload.rb#L149" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-set_association_single_records_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/association_preload.rb, line 149</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">set_association_single_records</span>(<span class="ruby-identifier">id_to_record_map</span>, <span class="ruby-identifier">reflection_name</span>, <span class="ruby-identifier">associated_records</span>, <span class="ruby-identifier">key</span>)
  <span class="ruby-identifier">seen_keys</span> = {}
  <span class="ruby-identifier">associated_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">associated_record</span><span class="ruby-operator">|</span>
    <span class="ruby-comment">#this is a has_one or belongs_to: there should only be one record.</span>
    <span class="ruby-comment">#Unfortunately we can&#39;t (in portable way) ask the database for</span>
    <span class="ruby-comment">#&#39;all records where foo_id in (x,y,z), but please</span>
    <span class="ruby-comment"># only one row per distinct foo_id&#39; so this where we enforce that</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">seen_keys</span>[<span class="ruby-identifier">associated_record</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_s</span>]
    <span class="ruby-identifier">seen_keys</span>[<span class="ruby-identifier">associated_record</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_s</span>] = <span class="ruby-keyword">true</span>
    <span class="ruby-identifier">mapped_records</span> = <span class="ruby-identifier">id_to_record_map</span>[<span class="ruby-identifier">associated_record</span>[<span class="ruby-identifier">key</span>].<span class="ruby-identifier">to_s</span>]
    <span class="ruby-identifier">mapped_records</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">mapped_record</span><span class="ruby-operator">|</span>
      <span class="ruby-identifier">association_proxy</span> = <span class="ruby-identifier">mapped_record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;set_#{reflection_name}_target&quot;</span>, <span class="ruby-identifier">associated_record</span>)
      <span class="ruby-identifier">association_proxy</span>.<span class="ruby-identifier">__send__</span>(<span class="ruby-value">:set_inverse_instance</span>, <span class="ruby-identifier">associated_record</span>, <span class="ruby-identifier">mapped_record</span>)
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-identifier">id_to_record_map</span>.<span class="ruby-identifier">each</span> <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-identifier">id</span>, <span class="ruby-identifier">records</span><span class="ruby-operator">|</span>
    <span class="ruby-keyword">next</span> <span class="ruby-keyword">if</span> <span class="ruby-identifier">seen_keys</span>.<span class="ruby-identifier">include?</span>(<span class="ruby-identifier">id</span>.<span class="ruby-identifier">to_s</span>)
    <span class="ruby-identifier">records</span>.<span class="ruby-identifier">each</span> {<span class="ruby-operator">|</span><span class="ruby-identifier">record</span><span class="ruby-operator">|</span> <span class="ruby-identifier">record</span>.<span class="ruby-identifier">send</span>(<span class="ruby-node">&quot;set_#{reflection_name}_target&quot;</span>, <span class="ruby-keyword">nil</span>) }
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    