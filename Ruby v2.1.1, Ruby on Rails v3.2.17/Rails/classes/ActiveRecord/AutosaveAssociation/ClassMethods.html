<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
    "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <title>ActiveRecord::AutosaveAssociation::ClassMethods</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <link rel="stylesheet" href="../../../css/reset.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/main.css" type="text/css" media="screen" />
<link rel="stylesheet" href="../../../css/github.css" type="text/css" media="screen" />
<script src="../../../js/jquery-1.3.2.min.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/jquery-effect.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/main.js" type="text/javascript" charset="utf-8"></script>
<script src="../../../js/highlight.pack.js" type="text/javascript" charset="utf-8"></script>

</head>

<body>     
    <div class="banner">
        
        <h1>
            <span class="type">Module</span> 
            ActiveRecord::AutosaveAssociation::ClassMethods 
            
        </h1>
        <ul class="files">
            
            <li><a href="../../../files/activerecord/lib/active_record/autosave_association_rb.html">activerecord/lib/active_record/autosave_association.rb</a></li>
            
        </ul>
    </div>
    <div id="bodyContent">
        <div id="content">
  


  


  
  


  


  
    <!-- Method ref -->
    <div class="sectiontitle">Methods</div>
    <dl class="methods">
      
        <dt>A</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-add_autosave_association_callbacks">add_autosave_association_callbacks</a>
              </li>
            
          </ul>
        </dd>
      
        <dt>D</dt>
        <dd>
          <ul>
            
              
              <li>
                <a href="#method-i-define_non_cyclic_method">define_non_cyclic_method</a>
              </li>
            
          </ul>
        </dd>
      
    </dl>
  

  



  

    

    

    


    


    <!-- Methods -->
        
      <div class="sectiontitle">Instance Private methods</div>
      
        <div class="method">
          <div class="title method-title" id="method-i-add_autosave_association_callbacks">
            
              <b>add_autosave_association_callbacks</b>(reflection)
            
            <a href="../../../classes/ActiveRecord/AutosaveAssociation/ClassMethods.html#method-i-add_autosave_association_callbacks" name="method-i-add_autosave_association_callbacks" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              <p>Adds validation and save callbacks for the association as specified by the
<code>reflection</code>.</p>

<p>For performance reasons, we don&#39;t check whether to validate at runtime.
However the validation and callback methods are lazy and those methods get
created when they are invoked for the very first time. However, this can
change, for instance, when using nested attributes, which is called
<em>after</em> the association has been defined. Since we don&#39;t want
the callbacks to get defined multiple times, there are guards that check if
the save or validation methods have already been defined before actually
defining them.</p>
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-add_autosave_association_callbacks_source')" id="l_method-i-add_autosave_association_callbacks_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/1c2545a45537661c3b1e896dd93b87377a65eb31/activerecord/lib/active_record/autosave_association.rb#L182" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-add_autosave_association_callbacks_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/autosave_association.rb, line 182</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">add_autosave_association_callbacks</span>(<span class="ruby-identifier">reflection</span>)
  <span class="ruby-identifier">save_method</span> = <span class="ruby-value">:&quot;autosave_associated_records_for_#{reflection.name}&quot;</span>
  <span class="ruby-identifier">validation_method</span> = <span class="ruby-value">:&quot;validate_associated_records_for_#{reflection.name}&quot;</span>
  <span class="ruby-identifier">collection</span> = <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">collection?</span>

  <span class="ruby-keyword">unless</span> <span class="ruby-identifier">method_defined?</span>(<span class="ruby-identifier">save_method</span>)
    <span class="ruby-keyword">if</span> <span class="ruby-identifier">collection</span>
      <span class="ruby-identifier">before_save</span> <span class="ruby-value">:before_save_collection_association</span>

      <span class="ruby-identifier">define_non_cyclic_method</span>(<span class="ruby-identifier">save_method</span>, <span class="ruby-identifier">reflection</span>) { <span class="ruby-identifier">save_collection_association</span>(<span class="ruby-identifier">reflection</span>) }
      <span class="ruby-comment"># Doesn&#39;t use after_save as that would save associations added in after_create/after_update twice</span>
      <span class="ruby-identifier">after_create</span> <span class="ruby-identifier">save_method</span>
      <span class="ruby-identifier">after_update</span> <span class="ruby-identifier">save_method</span>
    <span class="ruby-keyword">else</span>
      <span class="ruby-keyword">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">macro</span> <span class="ruby-operator">==</span> <span class="ruby-value">:has_one</span>
        <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">save_method</span>) { <span class="ruby-identifier">save_has_one_association</span>(<span class="ruby-identifier">reflection</span>) }
        <span class="ruby-comment"># Configures two callbacks instead of a single after_save so that</span>
        <span class="ruby-comment"># the model may rely on their execution order relative to its</span>
        <span class="ruby-comment"># own callbacks.</span>
        <span class="ruby-comment">#</span>
        <span class="ruby-comment"># For example, given that after_creates run before after_saves, if</span>
        <span class="ruby-comment"># we configured instead an after_save there would be no way to fire</span>
        <span class="ruby-comment"># a custom after_create callback after the child association gets</span>
        <span class="ruby-comment"># created.</span>
        <span class="ruby-identifier">after_create</span> <span class="ruby-identifier">save_method</span>
        <span class="ruby-identifier">after_update</span> <span class="ruby-identifier">save_method</span>
      <span class="ruby-keyword">else</span>
        <span class="ruby-identifier">define_non_cyclic_method</span>(<span class="ruby-identifier">save_method</span>, <span class="ruby-identifier">reflection</span>) { <span class="ruby-identifier">save_belongs_to_association</span>(<span class="ruby-identifier">reflection</span>) }
        <span class="ruby-identifier">before_save</span> <span class="ruby-identifier">save_method</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>
  <span class="ruby-keyword">end</span>

  <span class="ruby-keyword">if</span> <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">validate?</span> <span class="ruby-operator">&amp;&amp;</span> <span class="ruby-operator">!</span><span class="ruby-identifier">method_defined?</span>(<span class="ruby-identifier">validation_method</span>)
    <span class="ruby-identifier">method</span> = (<span class="ruby-identifier">collection</span> <span class="ruby-operator">?</span> <span class="ruby-value">:validate_collection_association</span> <span class="ruby-operator">:</span> <span class="ruby-value">:validate_single_association</span>)
    <span class="ruby-identifier">define_non_cyclic_method</span>(<span class="ruby-identifier">validation_method</span>, <span class="ruby-identifier">reflection</span>) { <span class="ruby-identifier">send</span>(<span class="ruby-identifier">method</span>, <span class="ruby-identifier">reflection</span>) }
    <span class="ruby-identifier">validate</span> <span class="ruby-identifier">validation_method</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
        
        <div class="method">
          <div class="title method-title" id="method-i-define_non_cyclic_method">
            
              <b>define_non_cyclic_method</b>(name, reflection, &amp;block)
            
            <a href="../../../classes/ActiveRecord/AutosaveAssociation/ClassMethods.html#method-i-define_non_cyclic_method" name="method-i-define_non_cyclic_method" class="permalink">Link</a>
          </div>
          
          
            <div class="description">
              
            </div>
          
          
          

          
          
          
            
            <div class="sourcecode">
              
              <p class="source-link">
                Source: 
                <a href="javascript:toggleSource('method-i-define_non_cyclic_method_source')" id="l_method-i-define_non_cyclic_method_source">show</a>
                
                  | <a href="https://github.com/mdesantis/rails/blob/1c2545a45537661c3b1e896dd93b87377a65eb31/activerecord/lib/active_record/autosave_association.rb#L154" target="_blank" class="github_url">on GitHub</a>
                
              </p>
              <div id="method-i-define_non_cyclic_method_source" class="dyn-source">
                <pre><span class="ruby-comment"># File activerecord/lib/active_record/autosave_association.rb, line 154</span>
<span class="ruby-keyword">def</span> <span class="ruby-keyword ruby-title">define_non_cyclic_method</span>(<span class="ruby-identifier">name</span>, <span class="ruby-identifier">reflection</span>, <span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
  <span class="ruby-identifier">define_method</span>(<span class="ruby-identifier">name</span>) <span class="ruby-keyword">do</span> <span class="ruby-operator">|</span><span class="ruby-operator">*</span><span class="ruby-identifier">args</span><span class="ruby-operator">|</span>
    <span class="ruby-identifier">result</span> = <span class="ruby-keyword">true</span>; <span class="ruby-ivar">@_already_called</span> <span class="ruby-operator">||=</span> {}
    <span class="ruby-comment"># Loop prevention for validation of associations</span>
    <span class="ruby-keyword">unless</span> <span class="ruby-ivar">@_already_called</span>[[<span class="ruby-identifier">name</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>]]
      <span class="ruby-keyword">begin</span>
        <span class="ruby-ivar">@_already_called</span>[[<span class="ruby-identifier">name</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>]]=<span class="ruby-keyword">true</span>
        <span class="ruby-identifier">result</span> = <span class="ruby-identifier">instance_eval</span>(<span class="ruby-operator">&amp;</span><span class="ruby-identifier">block</span>)
      <span class="ruby-keyword">ensure</span>
        <span class="ruby-ivar">@_already_called</span>[[<span class="ruby-identifier">name</span>, <span class="ruby-identifier">reflection</span>.<span class="ruby-identifier">name</span>]]=<span class="ruby-keyword">false</span>
      <span class="ruby-keyword">end</span>
    <span class="ruby-keyword">end</span>

    <span class="ruby-identifier">result</span>
  <span class="ruby-keyword">end</span>
<span class="ruby-keyword">end</span></pre>
              </div>
            </div>
            
          </div>
                    </div>

    </div>
  </body>
</html>    